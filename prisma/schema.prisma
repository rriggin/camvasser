// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// End-user leads (homeowners searching for their project photos)
model User {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  email     String
  phone     String
  address   String   // The address they searched for
  projectId String?  // CompanyCam project ID they viewed
  tenant    String   // Which business this lead belongs to (e.g., "budroofing")
  createdAt DateTime @default(now())

  @@index([tenant])
  @@index([createdAt])
}

// Business users (contractors signing up to use Camvasser)
model BusinessUser {
  id           String   @id @default(cuid())
  name         String   // Person's name
  email        String   @unique
  phone        String
  companyName  String
  domain       String?  // Their website domain
  slug         String?  @unique // URL slug like "budroofing"
  status       String   @default("pending") // pending, approved, rejected
  passwordHash String?  // Hashed password for login
  createdAt    DateTime @default(now())
  approvedAt   DateTime?

  @@index([createdAt])
  @@index([status])
  @@index([email])
}

// CompanyCam project data (synced from API)
model Project {
  id                    String   @id  // CompanyCam project ID
  tenant                String?  // Which business (e.g., "budroofing") - optional for global sync

  // CompanyCam identifiers
  companyId             String?
  creatorId             String?
  creatorType           String?
  creatorName           String?

  // Status
  status                String?  // active, deleted, etc
  archived              Boolean  @default(false)
  public                Boolean  @default(true)

  // Project info
  name                  String?

  // Address fields
  address               String?  // street_address_1
  streetAddress2        String?
  city                  String?
  state                 String?
  postalCode            String?
  country               String?

  // URLs and identifiers
  slug                  String?
  projectUrl            String?
  publicUrl             String?
  embeddedProjectUrl    String?

  // Location
  coordinates           Json?    // {lat, lon}
  geofence              Json?    // Array of coordinates

  // Media
  featureImage          Json?    // Array of image objects (original, web, thumbnail)
  photoCount            Int      @default(0)
  photos                Json?    // Array of photo objects from API
  videos                Json?    // Array of video objects from API
  documents             Json?    // Array of document objects from API

  // Integrations & metadata
  integrations          Json?    // Array of integration objects
  primaryContact        Json?
  notepad               String?
  tags                  Json?    // Array of tag/label objects from API

  // Timestamps from CompanyCam
  ccCreatedAt           DateTime?  // created_at from API
  ccUpdatedAt           DateTime?  // updated_at from API

  // Sync tracking
  lastSyncedAt          DateTime @default(now())
  whitepagesEnrichedAt  DateTime?  // When prospects were fetched from Whitepages
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  labels                ProjectLabel[]
  prospects             Prospect[]

  @@index([tenant])
  @@index([address])
  @@index([city, state])
  @@index([status])
  @@index([ccUpdatedAt])
  @@index([lastSyncedAt])
}

// Prospects discovered via Whitepages reverse address lookup
model Prospect {
  id                    String   @id @default(cuid())

  // Whitepages identifiers
  whitepagesId          String   @unique  // Whitepages person ID (e.g., "PX3vb4nlq3k")

  // Link to project (the address we looked up)
  projectId             String?
  project               Project? @relation(fields: [projectId], references: [id])

  // Basic info
  name                  String
  aliases               Json?    // Array of alternate names
  isDead                Boolean  @default(false)
  dateOfBirth           String?  // Format: "1991-10-04" or partial "1915-00-00"

  // Contact info (arrays with metadata)
  phones                Json?    // [{number, type, score}, ...]
  emails                Json?    // ["email1@x.com", "email2@y.com"]

  // Addresses
  currentAddresses      Json?    // [{id, address}, ...]
  historicAddresses     Json?    // [{id, address}, ...]
  ownedProperties       Json?    // [{id, address}, ...] - indicates property ownership

  // Professional info
  linkedinUrl           String?
  companyName           String?
  jobTitle              String?

  // Relationships
  relatives             Json?    // [{id, name}, ...]

  // Flags
  isHomeowner           Boolean  @default(false)  // Computed: has owned_properties at lookup address
  isCurrentResident     Boolean  @default(false)  // Computed: current_addresses includes lookup address

  // Call status tracking
  status                String?  // Call status: left_voicemail, hung_up, wrong_number, callback, appointment_set, bad_number, follow_up_email_sent, roof_replaced, not_interested, no_need, no_answer, wants_quote_phone, follow_up_sms_sent

  // Tracking
  lookupAddress         String?  // The address we used to find this prospect
  tenant                String?  // Which business tenant this belongs to

  // Timestamps
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([projectId])
  @@index([tenant])
  @@index([isHomeowner])
  @@index([isCurrentResident])
  @@index([name])
}

// Project labels (tags/statuses from CompanyCam)
model ProjectLabel {
  id           String   @id @default(cuid())
  projectId    String   // Links to Project
  labelId      String   // CompanyCam label ID
  displayValue String   // "Door Hanger"
  value        String   // "door hanger"
  tagType      String   // "project"

  createdAt    DateTime @default(now())

  project      Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([value])
}
