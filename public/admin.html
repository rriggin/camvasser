<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Camvasser Admin - Leads Dashboard</title>
  <link rel="icon" type="image/png" href="/favicon.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', -apple-system, system-ui, sans-serif;
      background: #f5f5f5;
      color: #212529;
      padding: 20px 15px;
      font-size: 13px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .company-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 6px;
      background: white;
      padding: 5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .header-text h1 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .header-text .subtitle {
      color: #6C757D;
      font-size: 12px;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #DC3545;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 12px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #C82333;
      transform: translateY(-1px);
    }

    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #E5E5E5;
    }

    .tab {
      padding: 8px 16px;
      background: none;
      border: none;
      font-size: 13px;
      font-weight: 600;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      color: #6C757D;
      border-bottom: 2px solid transparent;
      transition: all 0.3s;
      margin-bottom: -2px;
    }

    .tab:hover {
      color: #212529;
    }

    .tab.active {
      color: #FFC107;
      border-bottom-color: #FFC107;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      min-width: 220px;
    }

    .stat-card {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .stat-label {
      color: #6C757D;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: #FFC107;
    }

    .chart-card {
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      flex: 1;
    }

    .chart-title {
      color: #6C757D;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .chart-card canvas {
      width: 100% !important;
      height: 80px;
    }

    @media (max-width: 968px) {
      .stats {
        grid-template-columns: 1fr;
      }
    }

    .filters {
      background: white;
      padding: 10px 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filters select {
      padding: 6px 10px;
      border: 1px solid #E5E5E5;
      border-radius: 6px;
      font-family: 'Outfit', sans-serif;
      font-size: 12px;
    }

    .leads-table {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th {
      background: #F8F9FA;
      padding: 8px 10px;
      text-align: left;
      font-weight: 600;
      color: #212529;
      border-bottom: 1px solid #E5E5E5;
      font-size: 11px;
    }

    td {
      padding: 8px 10px;
      border-bottom: 1px solid #F8F9FA;
    }

    tr:hover {
      background: #F8F9FA;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge-tenant {
      background: #FFF9E6;
      color: #856404;
    }

    .loader {
      text-align: center;
      padding: 60px;
      color: #6C757D;
    }

    .empty-state {
      text-align: center;
      padding: 60px;
      color: #6C757D;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .settings-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 20px;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #212529;
    }

    .settings-grid {
      display: grid;
      gap: 20px;
    }

    .settings-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .settings-label {
      color: #6C757D;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .settings-value {
      color: #212529;
      font-size: 15px;
      padding: 12px;
      background: #F8F9FA;
      border-radius: 6px;
      font-family: 'Monaco', 'Courier New', monospace;
      word-break: break-all;
    }

    @media (max-width: 768px) {
      body {
        padding: 20px 10px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }

      .header-left {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-text h1 {
        font-size: 24px;
      }

      .company-logo {
        width: 50px;
        height: 50px;
      }

      .logout-btn {
        width: 100%;
      }

      .leads-table {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 12px;
        position: relative;
      }

      .leads-table::after {
        content: '‚Üê Swipe to see more ‚Üí';
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 193, 7, 0.9);
        color: #1a1a1a;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        pointer-events: none;
        opacity: 0;
        animation: fadeInOut 3s ease-in-out 1s infinite;
      }

      @keyframes fadeInOut {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
      }

      table {
        min-width: 800px;
        font-size: 13px;
      }

      th, td {
        padding: 10px 8px;
        white-space: nowrap;
      }

      th {
        font-size: 12px;
      }

      .stat-card, .chart-card {
        padding: 16px;
      }

      .stat-value {
        font-size: 28px;
      }
    }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .pagination button {
      padding: 5px 10px;
      border: 1px solid #E5E5E5;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
      font-weight: 600;
      font-size: 11px;
      transition: all 0.2s;
    }

    .pagination button:hover:not(:disabled) {
      border-color: #FFC107;
      background: #FFF9E6;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: #FFC107;
      border-color: #FFC107;
      color: #1a1a1a;
    }

    .pagination-info {
      color: #6C757D;
      font-size: 11px;
      margin: 0 8px;
    }

    th.sortable {
      cursor: pointer;
      user-select: none;
      position: relative;
      padding-right: 18px;
    }

    th.sortable:hover {
      background: #E9ECEF;
    }

    th.sortable::after {
      content: '‚áÖ';
      position: absolute;
      right: 8px;
      opacity: 0.3;
      font-size: 12px;
    }

    th.sortable.asc::after {
      content: '‚Üë';
      opacity: 1;
    }

    th.sortable.desc::after {
      content: '‚Üì';
      opacity: 1;
    }

    .tag-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 9px;
      font-weight: 600;
      margin: 1px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <img id="companyLogo" class="company-logo" src="" alt="Company Logo">
        <div class="header-text">
          <h1>Camvasser Admin</h1>
          <p class="subtitle">View and manage your leads</p>
        </div>
      </div>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('prospects')">Contacts</button>
      <button class="tab" onclick="switchTab('projects')">Addresses</button>
      <button class="tab" onclick="switchTab('leads')">Leads</button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- End-User Leads Section -->
    <div class="tab-content" id="leads-content">
      <div class="stats" id="leadsStats">
        <!-- Leads stats will be populated here -->
      </div>
      <div class="filters">
        <input type="text" id="leadSearch" placeholder="name:john, email:gmail, phone:816" oninput="debounceLeadSearch()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; flex: 1;">
        <button id="showAllLeadsBtn" style="margin-left: 8px; padding: 6px 12px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; cursor: pointer;">Show all</button>
      </div>
      <div class="leads-table">
        <table id="leadsTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="createdAt" onclick="sortTable('leads', 'createdAt')">Date</th>
              <th class="sortable" data-sort="name" onclick="sortTable('leads', 'name')">Name</th>
              <th class="sortable" data-sort="email" onclick="sortTable('leads', 'email')">Email</th>
              <th class="sortable" data-sort="phone" onclick="sortTable('leads', 'phone')">Phone</th>
              <th class="sortable" data-sort="address" onclick="sortTable('leads', 'address')">Address</th>
              <th>Project ID</th>
            </tr>
          </thead>
          <tbody id="endUserLeads">
            <tr>
              <td colspan="6" class="loader">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="leadsPagination" class="pagination"></div>
    </div>

    <!-- Projects Section -->
    <div class="tab-content" id="projects-content">
      <div class="stats" id="projectsStats">
        <!-- Project stats will be populated here -->
      </div>
      <div class="filters">
        <input type="text" id="projectSearch" placeholder="address:main, city:sedalia, tag:residential, contacts:yes" oninput="debounceProjectSearch()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; flex: 1;">
        <button id="showAllProjectsBtn" style="margin-left: 8px; padding: 6px 12px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; cursor: pointer;">Show all</button>
      </div>
      <div class="leads-table">
        <table id="projectsTable">
          <thead>
            <tr>
              <th>Photo</th>
              <th class="sortable" data-sort="address" onclick="sortTable('projects', 'address')">Address</th>
              <th class="sortable" data-sort="city" onclick="sortTable('projects', 'city')">City</th>
              <th class="sortable" data-sort="state" onclick="sortTable('projects', 'state')">State</th>
              <th class="sortable" data-sort="ccCreatedAt" onclick="sortTable('projects', 'ccCreatedAt')">Created</th>
              <th>Tags</th>
              <th class="sortable" data-sort="photoCount" onclick="sortTable('projects', 'photoCount')">Photos</th>
              <th class="sortable" data-sort="prospectCount" onclick="sortTable('projects', 'prospectCount')">Prospects</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="projectsList">
            <tr>
              <td colspan="9" class="loader">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="projectsPagination" class="pagination"></div>
    </div>

    <!-- Prospects Section -->
    <div class="tab-content active" id="prospects-content">
      <div class="stats" id="prospectsStats">
        <!-- Prospect stats will be populated here -->
      </div>
      <div class="filters">
        <input type="text" id="prospectSearch" placeholder="name:john, status:interested, email:yes" oninput="debounceProspectSearch()" style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; flex: 1;">
        <select id="prospectTagFilter" onchange="loadProspects(1, this.value !== '')" style="padding: 6px 10px; border: 1px solid #E5E5E5; border-radius: 6px; font-family: 'Outfit', sans-serif; font-size: 12px;">
          <option value="">All Tags</option>
        </select>
        <select id="prospectStatusFilter" onchange="loadProspects(1)" style="padding: 6px 10px; border: 1px solid #E5E5E5; border-radius: 6px; font-family: 'Outfit', sans-serif; font-size: 12px;">
          <option value="">All Statuses</option>
          <option value="no_status">No Status</option>
          <option value="left_voicemail">Left voicemail</option>
          <option value="no_answer">No answer</option>
          <option value="callback">Callback</option>
          <option value="appointment_set">Appointment set</option>
          <option value="wants_quote_phone">Wants quote over phone</option>
          <option value="not_interested">Not interested</option>
          <option value="wrong_number">Wrong number</option>
          <option value="bad_number">Bad number</option>
          <option value="hung_up">Hung up</option>
          <option value="no_need">No need</option>
          <option value="roof_replaced">Roof replaced</option>
          <option value="follow_up_email_sent">Follow-up email sent</option>
          <option value="follow_up_sms_sent">Follow-up SMS sent</option>
        </select>
        <span id="prospectCount" style="margin-left: 8px; padding: 6px 12px; font-size: 12px; font-family: 'Outfit', sans-serif; color: #6C757D;"></span>
        <div id="projectFilter" style="display: none; margin-left: 15px; padding: 8px 16px; background: #FFF9E6; border-radius: 8px; color: #856404;">
          <span id="projectFilterText"></span>
          <button onclick="clearProjectFilter()" style="margin-left: 10px; background: none; border: none; cursor: pointer; font-weight: bold; color: #856404;">&times;</button>
        </div>
      </div>
      <div class="leads-table">
        <table id="prospectsTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="name" onclick="sortTable('prospects', 'name')">Name</th>
              <th class="sortable" data-sort="project" onclick="sortTable('prospects', 'project')">Address</th>
              <th>Tags</th>
              <th>Phone</th>
              <th>Email</th>
              <th>Type</th>
              <th class="sortable" data-sort="status" onclick="sortTable('prospects', 'status')">Status</th>
              <th class="sortable" data-sort="updatedAt" onclick="sortTable('prospects', 'updatedAt')">Updated</th>
              <th class="sortable" data-sort="createdAt" onclick="sortTable('prospects', 'createdAt')">Created</th>
            </tr>
          </thead>
          <tbody id="prospectsList">
            <tr>
              <td colspan="9" class="loader">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="prospectsPagination" class="pagination"></div>
    </div>

    <!-- Settings Section -->
    <div class="tab-content" id="settings-content">
      <div class="settings-card" style="margin-top: 0;">
        <div class="settings-title">Account Settings</div>
        <div class="settings-grid">
          <div class="settings-item">
            <div class="settings-label">Domain</div>
            <div class="settings-value" id="settingsDomain">-</div>
          </div>
          <div class="settings-item">
            <div class="settings-label">CompanyCam API Key</div>
            <div class="settings-value" id="settingsApiKey">-</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let endUserLeadsData = [];
    let projectsData = [];
    let prospectsData = [];
    let authToken = null;
    let currentUser = null;

    // Pagination state
    const PAGE_SIZE = 25;
    let leadsPagination = { page: 1, total: 0, totalPages: 0 };
    let projectsPagination = { page: 1, total: 0, totalPages: 0 };
    let prospectsPagination = { page: 1, total: 0, totalPages: 0 };

    // Sort state
    let sortState = {
      leads: { column: 'createdAt', direction: 'desc' },
      projects: { column: 'address', direction: 'asc' },
      prospects: { column: 'name', direction: 'asc' }
    };

    // Search debounce for prospects
    let prospectSearchTimeout = null;
    window.debounceProspectSearch = function() {
      clearTimeout(prospectSearchTimeout);
      prospectSearchTimeout = setTimeout(() => {
        const searchValue = document.getElementById('prospectSearch')?.value?.trim().toLowerCase();
        // "all" or "show all" triggers show all
        if (searchValue === 'all' || searchValue === 'show all') {
          document.getElementById('prospectSearch').value = '';
          loadProspects(1, true);
        } else {
          loadProspects(1);
        }
      }, 300);
    };

    window.clearProspectSearch = function() {
      console.log('clearProspectSearch called');
      document.getElementById('prospectSearch').value = '';
      // Clear project filter without reloading (we'll reload after)
      currentProjectFilter = null;
      const projectFilterEl = document.getElementById('projectFilter');
      if (projectFilterEl) projectFilterEl.style.display = 'none';
      console.log('Calling loadProspects(1)');
      loadProspects(1);
    };

    // Search debounce for projects
    let projectSearchTimeout = null;
    let showAllProjects = false;
    window.debounceProjectSearch = function() {
      clearTimeout(projectSearchTimeout);
      projectSearchTimeout = setTimeout(() => loadProjects(1), 300);
    };

    // Search debounce for leads
    let leadSearchTimeout = null;
    let showAllLeads = false;
    window.debounceLeadSearch = function() {
      clearTimeout(leadSearchTimeout);
      leadSearchTimeout = setTimeout(() => loadEndUserLeads(1), 300);
    };

    // Tag color palette - vibrant, distinguishable colors
    const tagColors = [
      { bg: '#E3F2FD', text: '#1565C0' },  // Blue
      { bg: '#E8F5E9', text: '#2E7D32' },  // Green
      { bg: '#FFF3E0', text: '#E65100' },  // Orange
      { bg: '#F3E5F5', text: '#7B1FA2' },  // Purple
      { bg: '#E0F7FA', text: '#00838F' },  // Cyan
      { bg: '#FCE4EC', text: '#C2185B' },  // Pink
      { bg: '#FFF8E1', text: '#F9A825' },  // Amber
      { bg: '#E8EAF6', text: '#3949AB' },  // Indigo
      { bg: '#EFEBE9', text: '#5D4037' },  // Brown
      { bg: '#F1F8E9', text: '#558B2F' },  // Light Green
      { bg: '#E1F5FE', text: '#0277BD' },  // Light Blue
      { bg: '#FBE9E7', text: '#D84315' },  // Deep Orange
    ];

    // Hash function to get consistent color for a tag
    function getTagColor(tagValue) {
      let hash = 0;
      const str = tagValue.toLowerCase();
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash = hash & hash; // Convert to 32bit integer
      }
      const index = Math.abs(hash) % tagColors.length;
      return tagColors[index];
    }

    // Generate tag badge HTML
    function renderTagBadge(tag) {
      const color = getTagColor(tag.value || tag.display_value);
      return `<span class="tag-badge" style="background: ${color.bg}; color: ${color.text};">${tag.display_value}</span>`;
    }

    // Check authentication on page load
    window.addEventListener('load', () => {
      authToken = localStorage.getItem('authToken');
      const userStr = localStorage.getItem('user');

      if (!authToken || !userStr) {
        // Redirect to login if not authenticated
        window.location.href = '/login.html';
        return;
      }

      currentUser = JSON.parse(userStr);

      // Update page title with company name
      document.querySelector('.header-text h1').textContent = `${currentUser.companyName} - Leads Dashboard`;
      document.querySelector('.header-text .subtitle').textContent = `Viewing leads for ${currentUser.slug}`;

      // Load settings
      loadSettings();

      // Load contacts (default tab)
      loadProspects(1);


      // Set up Show all button click handler for Addresses
      document.getElementById('showAllProjectsBtn').addEventListener('click', function() {
        document.getElementById('projectSearch').value = '';
        loadProjects(1, true); // true = show all on one page
      });

      // Set up Show all button click handler for Leads
      document.getElementById('showAllLeadsBtn').addEventListener('click', function() {
        document.getElementById('leadSearch').value = '';
        loadEndUserLeads(1, true); // true = show all on one page
      });
    });

    async function loadSettings() {
      // Fetch settings from tenant config
      try {
        const response = await fetch(`/.netlify/functions/get-settings`, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();

          // Set company logo from tenant config
          const logoImg = document.getElementById('companyLogo');
          logoImg.src = data.logo || '/company-cam-logo.png';

          // Set domain
          document.getElementById('settingsDomain').textContent = data.domain || 'Not set';

          // Set API key
          document.getElementById('settingsApiKey').textContent = data.apiKey || 'Not configured';
        }
      } catch (error) {
        console.error('Error loading settings:', error);
        document.getElementById('settingsApiKey').textContent = 'Error loading';
      }
    }

    async function loadEndUserLeads(page = 1, showAll = false) {
      showAllLeads = showAll;
      const search = document.getElementById('leadSearch')?.value || '';
      const { column, direction } = sortState.leads;
      const limit = showAll ? 1000 : PAGE_SIZE;
      let url = `/.netlify/functions/get-leads?limit=${limit}&page=${page}&sortBy=${column}&sortDir=${direction}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.status === 401) {
          // Token expired or invalid, redirect to login
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return;
        }

        const data = await response.json();

        endUserLeadsData = data.leads;
        leadsPagination = {
          page: data.page,
          total: data.total,
          totalPages: data.totalPages
        };
        renderEndUserLeads();
        renderPagination('leads', leadsPagination, loadEndUserLeads);
        updateStats();

      } catch (error) {
        console.error('Error loading end-user leads:', error);
        document.getElementById('endUserLeads').innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div>Failed to load leads</div>
          </td></tr>
        `;
      }
    }


    function renderEndUserLeads() {
      const tbody = document.getElementById('endUserLeads');

      if (endUserLeadsData.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <img src="https://y.yarn.co/232004e3-6758-41a1-a8b5-2778bd886e66_text.gif" alt="The leads are weak" style="max-width: 400px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-size: 14px; color: #6C757D;">No inquiries yet</div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = endUserLeadsData.map(lead => `
        <tr>
          <td>${formatDate(lead.createdAt)}</td>
          <td><strong>${lead.firstName} ${lead.lastName}</strong></td>
          <td>${lead.email}</td>
          <td>${lead.phone}</td>
          <td>${lead.address || '-'}</td>
          <td>${lead.projectId || '-'}</td>
        </tr>
      `).join('');
    }

    function renderBusinessUsers() {
      const tbody = document.getElementById('businessUsers');

      if (businessUsersData.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>No business signups yet</div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = businessUsersData.map(user => `
        <tr>
          <td>${formatDate(user.createdAt)}</td>
          <td><strong>${user.name}</strong></td>
          <td>${user.email}</td>
          <td>${user.phone}</td>
          <td>${user.companyName}</td>
          <td>${user.domain || '-'}</td>
        </tr>
      `).join('');
    }

    function populateTenantFilter() {
      const tenants = [...new Set(endUserLeadsData.map(lead => lead.tenant))];
      const select = document.getElementById('tenantFilter');

      // Keep "All Tenants" option and add others
      const currentValue = select.value;
      select.innerHTML = '<option value="">All Tenants</option>' +
        tenants.map(tenant => `<option value="${tenant}">${tenant}</option>`).join('');
      select.value = currentValue;
    }

    // Stats data from API
    let leadsStatsData = null;
    let projectsStatsData = null;
    let prospectsStatsData = null;

    async function loadStats(type) {
      try {
        const response = await fetch(`/.netlify/functions/get-stats?type=${type}&days=30`, {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        if (response.ok) {
          return await response.json();
        }
      } catch (error) {
        console.error(`Error loading ${type} stats:`, error);
      }
      return null;
    }

    async function updateStats() {
      // Load real stats from API
      leadsStatsData = await loadStats('leads');

      const total = leadsStatsData?.total || leadsPagination.total || 0;
      const statsHTML = `
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value">${total}</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Leads by Day (Last 30 Days)</div>
          <canvas id="leadsChart"></canvas>
        </div>
      `;
      document.getElementById('leadsStats').innerHTML = statsHTML;

      // Draw chart after DOM update
      setTimeout(() => drawLeadsChart(), 0);
    }

    function drawLeadsChart() {
      const canvas = document.getElementById('leadsChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.offsetWidth;
      const height = 200;

      canvas.width = width;
      canvas.height = height;

      // Use API data if available, otherwise fall back to page data
      const last30Days = leadsStatsData?.data || getLast30DaysData();

      // Find max value for scaling
      const maxLeads = Math.max(...last30Days.map(d => d.count), 1);

      // Chart dimensions
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw grid lines
      ctx.strokeStyle = '#F0F0F0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }

      // Draw line
      ctx.strokeStyle = '#FFC107';
      ctx.lineWidth = 3;
      ctx.beginPath();

      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxLeads) * chartHeight;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      // Draw points
      ctx.fillStyle = '#FFC107';
      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxLeads) * chartHeight;

        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw Y-axis labels
      ctx.fillStyle = '#6C757D';
      ctx.font = '12px Outfit';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 5; i++) {
        const value = Math.round((maxLeads / 5) * (5 - i));
        const y = padding + (chartHeight / 5) * i;
        ctx.fillText(value.toString(), padding - 10, y + 4);
      }

      // Draw X-axis labels (show every 5th day)
      ctx.textAlign = 'center';
      last30Days.forEach((day, index) => {
        if (index % 5 === 0 || index === last30Days.length - 1) {
          const x = padding + (chartWidth / (last30Days.length - 1)) * index;
          ctx.fillText(day.label, x, height - 10);
        }
      });
    }

    function getLast30DaysData() {
      const days = [];
      const now = new Date();

      for (let i = 29; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0);

        const nextDate = new Date(date);
        nextDate.setDate(date.getDate() + 1);

        const count = endUserLeadsData.filter(lead => {
          const leadDate = new Date(lead.createdAt);
          return leadDate >= date && leadDate < nextDate;
        }).length;

        days.push({
          date,
          label: (date.getMonth() + 1) + '/' + date.getDate(),
          count
        });
      }

      return days;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    function switchTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tab}-content`).classList.add('active');

      // Load data if needed (always load first page)
      if (tab === 'projects' && projectsPagination.total === 0) {
        loadProjects(1);
      }
      if (tab === 'prospects' && prospectsPagination.total === 0) {
        loadProspects(1);
      }
      if (tab === 'leads' && leadsPagination.total === 0) {
        loadEndUserLeads(1);
      }
    }

    async function loadProjects(page = 1, showAll = false) {
      showAllProjects = showAll;
      const search = document.getElementById('projectSearch')?.value || '';
      const tagFilter = document.getElementById('tagFilter')?.value || '';
      const hasProspects = document.getElementById('hasProspectsFilter')?.checked;
      const { column, direction } = sortState.projects;
      const limit = showAll ? 1000 : PAGE_SIZE;
      let url = `/.netlify/functions/get-projects?limit=${limit}&page=${page}&sortBy=${column}&sortDir=${direction}`;
      if (search) url += `&search=${encodeURIComponent(search)}`;
      if (tagFilter) url += `&tag=${encodeURIComponent(tagFilter)}`;
      if (hasProspects) url += `&hasProspects=true`;

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.status === 401) {
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return;
        }

        const data = await response.json();
        projectsData = data.projects;
        projectsPagination = {
          page: data.page,
          total: data.total,
          totalPages: data.totalPages
        };
        renderProjects();
        renderPagination('projects', projectsPagination, loadProjects);
        loadAllTags();
        updateProjectsStats();

        // Update filter count
        const filterCountEl = document.getElementById('projectsFilterCount');
        const hasFilters = search || tagFilter || hasProspects;
        if (filterCountEl) {
          filterCountEl.textContent = hasFilters ? `${data.total} results` : '';
        }

      } catch (error) {
        console.error('Error loading projects:', error);
        document.getElementById('projectsList').innerHTML = `
          <tr><td colspan="7" class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div>Failed to load projects</div>
          </td></tr>
        `;
      }
    }

    async function updateProjectsStats() {
      // Load real stats from API
      projectsStatsData = await loadStats('projects');

      const total = projectsStatsData?.total || projectsPagination.total || 0;
      const withProspects = projectsStatsData?.withProspects || 0;
      const withoutProspects = total - withProspects;
      const thisWeek = projectsStatsData?.thisWeek || 0;
      const statsHTML = `
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total</div>
            <div class="stat-value">${total}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">This Week</div>
            <div class="stat-value">${thisWeek}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">With Contacts</div>
            <div class="stat-value" style="color: #28a745;">${withProspects}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">No Contacts</div>
            <div class="stat-value" style="color: #6c757d;">${withoutProspects}</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Projects by Day (Last 30 Days)</div>
          <canvas id="projectsChart"></canvas>
        </div>
      `;
      document.getElementById('projectsStats').innerHTML = statsHTML;
      setTimeout(() => drawProjectsChart(), 0);
    }

    function drawProjectsChart() {
      const canvas = document.getElementById('projectsChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.offsetWidth;
      const height = 80;

      canvas.width = width;
      canvas.height = height;

      // Use API data if available
      const last30Days = projectsStatsData?.data || getProjectsLast30DaysData();

      // Find max value for scaling
      const maxProjects = Math.max(...last30Days.map(d => d.count), 1);

      // Chart dimensions
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw grid lines
      ctx.strokeStyle = '#F0F0F0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }

      // Draw line
      ctx.strokeStyle = '#28a745';
      ctx.lineWidth = 3;
      ctx.beginPath();

      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxProjects) * chartHeight;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      // Draw points
      ctx.fillStyle = '#28a745';
      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxProjects) * chartHeight;

        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw Y-axis labels
      ctx.fillStyle = '#6C757D';
      ctx.font = '12px Outfit';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 5; i++) {
        const value = Math.round((maxProjects / 5) * (5 - i));
        const y = padding + (chartHeight / 5) * i;
        ctx.fillText(value.toString(), padding - 10, y + 4);
      }

      // Draw X-axis labels (show every 5th day)
      ctx.textAlign = 'center';
      last30Days.forEach((day, index) => {
        if (index % 5 === 0 || index === last30Days.length - 1) {
          const x = padding + (chartWidth / (last30Days.length - 1)) * index;
          ctx.fillText(day.label, x, height - 10);
        }
      });
    }

    function getProjectsLast30DaysData() {
      const days = [];
      const now = new Date();

      for (let i = 29; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0);

        const nextDate = new Date(date);
        nextDate.setDate(date.getDate() + 1);

        const count = projectsData.filter(project => {
          const projectDate = new Date(project.ccCreatedAt);
          return projectDate >= date && projectDate < nextDate;
        }).length;

        days.push({
          date,
          label: (date.getMonth() + 1) + '/' + date.getDate(),
          count
        });
      }

      return days;
    }

    function renderProjects() {
      const tbody = document.getElementById('projectsList');

      if (projectsData.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="9" class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>No projects synced yet</div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = projectsData.map(project => {
        // Get thumbnail from featureImage array
        const thumbnail = project.featureImage?.find(img => img.type === 'thumbnail')?.url ||
                         project.featureImage?.[0]?.url || '';

        // Format tags as colored badges
        const tagsHtml = project.tags?.length > 0
          ? project.tags.map(tag => renderTagBadge(tag)).join('')
          : '<span style="color: #999;">-</span>';

        // Prospects with individual links
        const prospectCount = project.prospectCount || 0;
        let prospectHtml = '<span style="color: #999;">0</span>';
        if (prospectCount > 0 && project.prospects?.length > 0) {
          const prospectLinks = project.prospects.map(p => {
            const badges = [];
            if (p.isHomeowner) badges.push('<span style="background: #d4edda; color: #155724; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 4px;">Owner</span>');
            if (p.isDead) badges.push('<span style="background: #f8d7da; color: #721c24; padding: 1px 4px; border-radius: 3px; font-size: 9px; margin-left: 4px;">Deceased</span>');
            return `<a href="#" onclick="viewProspect('${p.id}', '${project.id}'); return false;" style="color: #007bff; text-decoration: none; font-size: 12px; display: block; margin: 2px 0;">${p.name}${badges.join('')}</a>`;
          }).join('');
          prospectHtml = `
            <div style="max-height: 100px; overflow-y: auto;">
              ${prospectLinks}
            </div>
            <button onclick="viewProjectProspects('${project.id}', '${(project.address || '').replace(/'/g, "\\'")}', ${prospectCount})" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 11px; margin-top: 4px;">View all ${prospectCount}</button>
          `;
        }

        // Format created date
        const createdDate = project.ccCreatedAt ? formatDate(project.ccCreatedAt) : '-';

        return `
          <tr data-project-id="${project.id}">
            <td>
              ${thumbnail ?
                `<img src="${thumbnail}" alt="Project" style="width: 60px; height: 60px; object-fit: cover; border-radius: 6px;">` :
                '<div style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #999;">No img</div>'
              }
            </td>
            <td><strong>${project.address || '-'}</strong></td>
            <td>${project.city || '-'}</td>
            <td>${project.state || '-'}</td>
            <td style="white-space: nowrap;">${createdDate}</td>
            <td style="max-width: 250px;">${tagsHtml}</td>
            <td>${project.photoCount || 0}</td>
            <td style="min-width: 150px;">${prospectHtml}</td>
            <td>
              ${project.publicUrl ?
                `<a href="${project.publicUrl}" target="_blank" style="color: #FFC107; text-decoration: none; font-weight: 600;">View ‚Üí</a>` :
                '-'
              }
            </td>
          </tr>
        `;
      }).join('');
    }

    let currentProjectFilter = null;

    function viewProjectProspects(projectId, address, count) {
      currentProjectFilter = { id: projectId, address: address };

      // Show the filter badge
      document.getElementById('projectFilter').style.display = 'flex';
      document.getElementById('projectFilterText').textContent = `Filtering: ${address} (${count} prospects)`;

      // Switch to prospects tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[2].classList.add('active'); // Prospects tab
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('prospects-content').classList.add('active');

      // Load prospects for this project (reset to page 1)
      loadProspects(1);
    }

    function clearProjectFilter() {
      currentProjectFilter = null;
      document.getElementById('projectFilter').style.display = 'none';
      loadProspects(1);
    }

    function clearProjectFilters() {
      document.getElementById('projectSearch').value = '';
      document.getElementById('tagFilter').value = '';
      document.getElementById('hasProspectsFilter').checked = false;
      loadProjects(1);
    }

    // Collect all unique tags from API
    let allTags = [];
    let tagsLoaded = false;

    function populateTagFilter() {
      // Populate Addresses tag filter
      const select = document.getElementById('tagFilter');
      if (select) {
        const currentValue = select.value;
        select.innerHTML = '<option value="">All Tags</option>' +
          allTags.map(tag => `<option value="${tag.value}">${tag.display_value}</option>`).join('');
        select.value = currentValue;
      }

      // Populate Contacts tag filter
      const prospectSelect = document.getElementById('prospectTagFilter');
      if (prospectSelect) {
        const currentValue = prospectSelect.value;
        prospectSelect.innerHTML = '<option value="">All Tags</option>' +
          allTags.map(tag => `<option value="${tag.value}">${tag.display_value}</option>`).join('');
        prospectSelect.value = currentValue;
      }
    }

    async function loadAllTags() {
      if (tagsLoaded) return;

      try {
        const response = await fetch('/.netlify/functions/get-tags', {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          allTags = data.tags;
          tagsLoaded = true;
          populateTagFilter();
        }
      } catch (error) {
        console.error('Error loading tags:', error);
      }
    }

    function viewProject(projectId) {
      // Switch to projects tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[1].classList.add('active'); // Projects tab
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('projects-content').classList.add('active');

      // Find and highlight the project in the list, or search for it
      const existingProject = projectsData.find(p => p.id === projectId);
      if (existingProject) {
        // Project already loaded - scroll to it and highlight
        renderProjects();
        // Highlight effect using CSS
        setTimeout(() => {
          const row = document.querySelector(`#projectsList tr[data-project-id="${projectId}"]`);
          if (row) {
            row.style.background = '#FFF9E6';
            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      } else {
        // Load all projects to find it
        loadProjects();
      }
    }

    function viewProspect(prospectId, projectId) {
      // Set the project filter to show this prospect
      const project = projectsData.find(p => p.id === projectId);
      if (project) {
        currentProjectFilter = { id: projectId, address: project.address || 'Unknown' };
        document.getElementById('projectFilter').style.display = 'flex';
        document.getElementById('projectFilterText').textContent = `Filtering: ${project.address || 'Unknown'}`;
      }

      // Switch to prospects tab
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab')[2].classList.add('active'); // Prospects tab
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('prospects-content').classList.add('active');

      // Load prospects (page 1) and highlight the specific one
      loadProspects(1).then(() => {
        setTimeout(() => {
          const rows = document.querySelectorAll('#prospectsList tr');
          rows.forEach(row => {
            // Reset all backgrounds first
            row.style.background = '';
          });
          // Find the prospect by ID in the data and highlight
          const prospectIndex = prospectsData.findIndex(p => p.id === prospectId);
          if (prospectIndex >= 0 && rows[prospectIndex]) {
            rows[prospectIndex].style.background = '#FFF9E6';
            rows[prospectIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      });
    }

    let showAllProspects = false; // Track if we're showing all prospects

    async function loadProspects(page = 1, showAll = false) {
      showAllProspects = showAll;
      const searchQuery = document.getElementById('prospectSearch')?.value?.trim() || '';
      const tagFilter = document.getElementById('prospectTagFilter')?.value || '';
      const statusFilter = document.getElementById('prospectStatusFilter')?.value || '';
      const limit = showAll ? 1000 : PAGE_SIZE; // Use large limit when showing all
      console.log('loadProspects called, page:', page, 'search:', searchQuery, 'tag:', tagFilter, 'status:', statusFilter, 'showAll:', showAll);
      const { column, direction } = sortState.prospects;
      let url = `/.netlify/functions/get-prospects?limit=${limit}&page=${page}&sortBy=${column}&sortDir=${direction}`;
      if (searchQuery) url += `&search=${encodeURIComponent(searchQuery)}`;
      if (tagFilter) url += `&tag=${encodeURIComponent(tagFilter)}`;
      if (statusFilter) url += `&statusFilter=${encodeURIComponent(statusFilter)}`;
      console.log('Fetching URL:', url);

      if (currentProjectFilter) {
        url += `&projectId=${currentProjectFilter.id}`;
      }

      // Load tags for dropdown if not already loaded
      if (!tagsLoaded) loadAllTags();

      try {
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${authToken}`
          }
        });

        if (response.status === 401) {
          localStorage.removeItem('authToken');
          localStorage.removeItem('user');
          window.location.href = '/login.html';
          return;
        }

        const data = await response.json();
        console.log('Got data, total:', data.total, 'page:', data.page, 'totalPages:', data.totalPages);
        prospectsData = data.prospects;
        prospectsPagination = {
          page: data.page,
          total: data.total,
          totalPages: data.totalPages,
          homeowners: data.homeowners
        };
        renderProspects();
        renderPagination('prospects', prospectsPagination, loadProspects);
        updateProspectsStats();

        // Update count display
        const countEl = document.getElementById('prospectCount');
        if (countEl) {
          const showing = prospectsData.length;
          const total = data.total;
          countEl.textContent = showing === total ? `${total} contacts` : `${showing} of ${total} contacts`;
        }

      } catch (error) {
        console.error('Error loading prospects:', error);
        document.getElementById('prospectsList').innerHTML = `
          <tr><td colspan="6" class="empty-state">
            <div class="empty-state-icon">‚ö†Ô∏è</div>
            <div>Failed to load prospects</div>
          </td></tr>
        `;
      }
    }

    async function updateProspectsStats() {
      // Load real stats from API
      prospectsStatsData = await loadStats('prospects');

      const total = prospectsStatsData?.total || prospectsPagination.total || 0;
      const homeowners = prospectsStatsData?.homeowners || prospectsPagination.homeowners || 0;
      const statsHTML = `
        <div class="stats-row">
          <div class="stat-card">
            <div class="stat-label">Total Contacts</div>
            <div class="stat-value">${total}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Homeowners</div>
            <div class="stat-value">${homeowners}</div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Prospects by Day (Last 30 Days)</div>
          <canvas id="prospectsChart"></canvas>
        </div>
      `;
      document.getElementById('prospectsStats').innerHTML = statsHTML;
      setTimeout(() => drawProspectsChart(), 0);
    }

    function drawProspectsChart() {
      const canvas = document.getElementById('prospectsChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.offsetWidth;
      const height = 200;

      canvas.width = width;
      canvas.height = height;

      // Use API data if available
      const last30Days = prospectsStatsData?.data || getProspectsLast30DaysData();

      // Find max value for scaling
      const maxProspects = Math.max(...last30Days.map(d => d.count), 1);

      // Chart dimensions
      const padding = 40;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw grid lines
      ctx.strokeStyle = '#F0F0F0';
      ctx.lineWidth = 1;
      for (let i = 0; i <= 5; i++) {
        const y = padding + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
      }

      // Draw line
      ctx.strokeStyle = '#007bff';
      ctx.lineWidth = 3;
      ctx.beginPath();

      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxProspects) * chartHeight;

        if (index === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();

      // Draw points
      ctx.fillStyle = '#007bff';
      last30Days.forEach((day, index) => {
        const x = padding + (chartWidth / (last30Days.length - 1)) * index;
        const y = height - padding - (day.count / maxProspects) * chartHeight;

        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
      });

      // Draw Y-axis labels
      ctx.fillStyle = '#6C757D';
      ctx.font = '12px Outfit';
      ctx.textAlign = 'right';
      for (let i = 0; i <= 5; i++) {
        const value = Math.round((maxProspects / 5) * (5 - i));
        const y = padding + (chartHeight / 5) * i;
        ctx.fillText(value.toString(), padding - 10, y + 4);
      }

      // Draw X-axis labels (show every 5th day)
      ctx.textAlign = 'center';
      last30Days.forEach((day, index) => {
        if (index % 5 === 0 || index === last30Days.length - 1) {
          const x = padding + (chartWidth / (last30Days.length - 1)) * index;
          ctx.fillText(day.label, x, height - 10);
        }
      });
    }

    function getProspectsLast30DaysData() {
      const days = [];
      const now = new Date();

      for (let i = 29; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        date.setHours(0, 0, 0, 0);

        const nextDate = new Date(date);
        nextDate.setDate(date.getDate() + 1);

        const count = prospectsData.filter(prospect => {
          const prospectDate = new Date(prospect.createdAt);
          return prospectDate >= date && prospectDate < nextDate;
        }).length;

        days.push({
          date,
          label: (date.getMonth() + 1) + '/' + date.getDate(),
          count
        });
      }

      return days;
    }

    // Status options with colors
    const STATUS_OPTIONS = [
      { value: '', label: 'Select status...', bg: '#f8f9fa', text: '#6c757d' },
      { value: 'left_voicemail', label: 'Left voicemail', bg: '#fff3cd', text: '#856404' },
      { value: 'hung_up', label: 'Hung up', bg: '#f8d7da', text: '#721c24' },
      { value: 'wrong_number', label: 'Wrong number', bg: '#e2e3e5', text: '#383d41' },
      { value: 'callback', label: 'Callback', bg: '#e2e3e5', text: '#383d41' },
      { value: 'appointment_set', label: 'Appointment set', bg: '#d4edda', text: '#155724' },
      { value: 'bad_number', label: 'Bad number', bg: '#e2e3e5', text: '#383d41' },
      { value: 'follow_up_email_sent', label: 'Follow-up email sent', bg: '#d4edda', text: '#155724' },
      { value: 'roof_replaced', label: 'Roof replaced', bg: '#e2e3e5', text: '#383d41' },
      { value: 'not_interested', label: 'Not interested', bg: '#f8d7da', text: '#721c24' },
      { value: 'no_need', label: 'No need', bg: '#e2e3e5', text: '#383d41' },
      { value: 'no_answer', label: 'No answer', bg: '#e2e3e5', text: '#383d41' },
      { value: 'wants_quote_phone', label: 'Wants quote over the phone', bg: '#cce5ff', text: '#004085' },
      { value: 'follow_up_sms_sent', label: 'Follow up SMS Sent', bg: '#d4edda', text: '#155724' }
    ];

    function getStatusOption(value) {
      return STATUS_OPTIONS.find(s => s.value === value) || STATUS_OPTIONS[0];
    }

    async function updateProspectStatus(prospectId, status) {
      try {
        const response = await fetch('/.netlify/functions/update-prospect-status', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ prospectId, status })
        });

        if (!response.ok) {
          const data = await response.json();
          alert('Failed to update status: ' + (data.error || 'Unknown error'));
          return;
        }

        // Update local data
        const prospect = prospectsData.find(p => p.id === prospectId);
        if (prospect) {
          prospect.status = status || null;
        }

        // Update the dropdown styling
        const select = document.querySelector(`select[data-prospect-id="${prospectId}"]`);
        if (select) {
          const option = getStatusOption(status);
          select.style.background = option.bg;
          select.style.color = option.text;
        }
      } catch (error) {
        console.error('Error updating status:', error);
        alert('Failed to update status');
      }
    }

    function renderProspects() {
      const tbody = document.getElementById('prospectsList');

      if (prospectsData.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="9" class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>No contacts found</div>
          </td></tr>
        `;
        return;
      }

      tbody.innerHTML = prospectsData.map(prospect => {
        // Get best phone (highest score)
        const bestPhone = prospect.phones?.sort((a, b) => b.score - a.score)[0];
        const phoneDisplay = bestPhone ? `${bestPhone.number} <span style="color: #999; font-size: 11px;">(${bestPhone.type})</span>` : '-';

        // Get first email
        const emailDisplay = prospect.emails?.[0] || '-';

        // Type badges (Resident/Owner)
        let typeBadges = '';
        if (prospect.isHomeowner) {
          typeBadges += '<span class="badge" style="background: #d4edda; color: #155724; margin-right: 4px;">Owner</span>';
        }
        if (prospect.isCurrentResident) {
          typeBadges += '<span class="badge" style="background: #cce5ff; color: #004085;">Resident</span>';
        }
        if (prospect.isDead) {
          typeBadges += '<span class="badge" style="background: #f8d7da; color: #721c24;">Deceased</span>';
        }

        // Status dropdown
        const currentStatus = getStatusOption(prospect.status);
        const statusOptions = STATUS_OPTIONS.map(s =>
          `<option value="${s.value}" ${s.value === (prospect.status || '') ? 'selected' : ''}>${s.label}</option>`
        ).join('');
        const statusDropdown = `
          <select
            data-prospect-id="${prospect.id}"
            onchange="updateProspectStatus('${prospect.id}', this.value)"
            style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: 'Outfit', sans-serif; cursor: pointer; background: ${currentStatus.bg}; color: ${currentStatus.text}; min-width: 140px;"
          >
            ${statusOptions}
          </select>
        `;

        // Company info
        const companyInfo = prospect.jobTitle && prospect.companyName
          ? `${prospect.jobTitle}<br><span style="color: #999;">${prospect.companyName}</span>`
          : prospect.companyName || '-';

        // Project link
        let projectHtml = '-';
        if (prospect.project) {
          const projectAddress = prospect.project.address || 'Unknown';
          const projectLocation = [prospect.project.city, prospect.project.state].filter(Boolean).join(', ');
          projectHtml = `
            <a href="#" onclick="viewProject('${prospect.project.id}'); return false;" style="color: #FFC107; text-decoration: none; font-weight: 500;">
              ${projectAddress}
            </a>
            ${projectLocation ? `<br><span style="color: #999; font-size: 12px;">${projectLocation}</span>` : ''}
          `;
        } else if (prospect.lookupAddress) {
          projectHtml = `<span style="color: #999;">${prospect.lookupAddress}</span>`;
        }

        // Address tags
        const tagsHtml = prospect.project?.tags?.length > 0
          ? prospect.project.tags.map(tag => renderTagBadge(tag)).join('')
          : '<span style="color: #999;">-</span>';

        return `
          <tr>
            <td>
              <strong>${prospect.name}</strong>
              ${prospect.linkedinUrl ? `<a href="${prospect.linkedinUrl}" target="_blank" style="margin-left: 8px; color: #0077b5; text-decoration: none;">in</a>` : ''}
              ${prospect.dateOfBirth ? `<br><span style="color: #999; font-size: 12px;">DOB: ${prospect.dateOfBirth}</span>` : ''}
            </td>
            <td style="max-width: 200px;">${projectHtml}</td>
            <td style="max-width: 200px;">${tagsHtml}</td>
            <td>${phoneDisplay}</td>
            <td style="max-width: 200px; word-break: break-all; font-size: 13px;">${emailDisplay}</td>
            <td>${typeBadges || '-'}</td>
            <td>${statusDropdown}</td>
            <td style="white-space: nowrap; font-size: 13px; color: #6c757d;">${prospect.updatedAt ? formatDate(prospect.updatedAt).split(',')[0] : '-'}</td>
            <td style="white-space: nowrap; font-size: 13px; color: #6c757d;">${prospect.createdAt ? formatDate(prospect.createdAt).split(',')[0] : '-'}</td>
          </tr>
        `;
      }).join('');
    }

    // Sort function - server-side sorting
    function sortTable(tableType, column) {
      const state = sortState[tableType];

      // Toggle direction if same column, otherwise default to asc
      if (state.column === column) {
        state.direction = state.direction === 'asc' ? 'desc' : 'asc';
      } else {
        state.column = column;
        state.direction = 'asc';
      }

      // Update header styling
      const tableId = tableType === 'leads' ? 'leadsTable' : tableType === 'projects' ? 'projectsTable' : 'prospectsTable';
      const headers = document.querySelectorAll(`#${tableId} th.sortable`);
      headers.forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.dataset.sort === column) {
          th.classList.add(state.direction);
        }
      });

      // Trigger server-side fetch with sort params (reset to page 1)
      if (tableType === 'leads') {
        loadEndUserLeads(1);
      } else if (tableType === 'projects') {
        loadProjects(1);
      } else {
        loadProspects(1, showAllProspects); // Preserve showAll state when sorting
      }
    }

    // Pagination rendering helper
    function renderPagination(type, pagination, loadFn) {
      const container = document.getElementById(`${type}Pagination`);
      if (!container) return;

      const { page, total, totalPages, homeowners } = pagination;

      if (totalPages <= 1) {
        // Show just the info if only one page
        let info = `Showing ${total} ${type}`;
        if (type === 'prospects' && homeowners !== undefined) {
          info += ` (${homeowners} homeowners)`;
        }
        container.innerHTML = `<span class="pagination-info">${info}</span>`;
        return;
      }

      let html = '';

      // Previous button
      html += `<button onclick="${loadFn.name}(${page - 1})" ${page === 1 ? 'disabled' : ''}>‚Üê Prev</button>`;

      // Page numbers
      const maxPages = 5;
      let startPage = Math.max(1, page - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);
      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      if (startPage > 1) {
        html += `<button onclick="${loadFn.name}(1)">1</button>`;
        if (startPage > 2) {
          html += '<span class="pagination-info">...</span>';
        }
      }

      for (let i = startPage; i <= endPage; i++) {
        html += `<button onclick="${loadFn.name}(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += '<span class="pagination-info">...</span>';
        }
        html += `<button onclick="${loadFn.name}(${totalPages})">${totalPages}</button>`;
      }

      // Next button
      html += `<button onclick="${loadFn.name}(${page + 1})" ${page === totalPages ? 'disabled' : ''}>Next ‚Üí</button>`;

      // Info text
      const start = (page - 1) * PAGE_SIZE + 1;
      const end = Math.min(page * PAGE_SIZE, total);
      let info = `Showing ${start}-${end} of ${total}`;
      if (type === 'prospects' && homeowners !== undefined) {
        info += ` (${homeowners} homeowners)`;
      }
      html += `<span class="pagination-info">${info}</span>`;

      container.innerHTML = html;
    }

    // Command+K to focus search box on current tab
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();

        // Find the active tab's search input
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
          const searchInput = activeTab.querySelector('input[type="text"]');
          if (searchInput) {
            searchInput.focus();
            searchInput.select();
          }
        }
      }
    });
  </script>
</body>
</html>
